{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 text-center">
    <h2 class="fw-bold">Payment for {{ course.title }}</h2>
    <p class="lead">Price: â‚¹{{ amount }}</p>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <button id="pay-btn" class="btn btn-primary">Pay Now</button>

    <script>
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var options = {
            "key": "{{ key_id }}",
            "amount": Math.round(Number("{{ amount }}") * 100),  // Convert rupees to paise correctly
            "currency": "INR",
            "name": "LMS Payment",
            "description": "Enroll in {{ course.title }}",
            "order_id": "{{ order_id }}",
            "handler": function (response) {
                // Sending data via POST request to Django server
                fetch("{% url 'payment_success' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()  // Include CSRF token
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Payment successful! Redirecting...");
                        window.location.href = "{% url 'course_detail' course.id %}";  // Redirect to course page
                    } else {
                        alert("Payment verification failed: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        document.getElementById("pay-btn").onclick = function () {
            var rzp1 = new Razorpay(options);
            rzp1.open();
        };
    </script>
</div>
{% endblock %}
